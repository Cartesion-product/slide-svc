## 一、接口设计

### 1、任务创建接口

**接口路径**: `POST /namespace/{namespace}/tasks/create`

**功能描述**: 创建PPT/Poster生成任务，添加至队列，返回任务ID

**请求参数**:

```json
{
  "paper_id": "9407014",		// 论文ID
  "title": "全景信息图",			 // poster 默认 全景信息图 slides 默认 演示文稿
  "source": "arxiv",			// 论文数据源 arxiv、acl、neurips
  "paper_type": "system",  		// system-系统论文（默认）, user-用户论文
  "agent_type": "poster",  		// poster-全景信息图, slides-演示文稿
  "user_id": "dba5d6253cd018bb56ef48d22919b866",  // 用户ID
  "style": "风格偏好",
  "language": "ZH",			// 默认中文，ZH，英文，EN
  "desnity": "dense"		// 内容密度 spare medium dense
}
```

**响应结果**:

```json
{
  "code": 200,
  "message": "任务创建成功",
  "data": {
      "task_id": ""
  }
}
```

**业务逻辑**:

1. 验证必填参数（paper_id, source, agent_type），并通过token_payload: dict[str, None] = Depends(token_decoder)参数获取user_id = token_payload['user_id']；
2. 检查任务队列（可执行任务上限2，等待队列上限5），若等待队列上限则返回-任务繁忙；
3. 创建任务记录，状态为"等待中(waiting)"，写入 user_paper_agent_result 库记录，初始化状态init_state；
4. 根据 paper_id, source, agent_type 查询 system_paper_agent_result 表中是否存在记录。设置默认标记False。
   - 有记录的默认结果是否有值，
     - 有值且用户存在创建记录，则继续后续流程提交Celery异步任务重新生成，任务返回任务ID；
     - 有值则获取值更新创建的任务，并更新状态为success，返回任务ID；
     - 无值则将状态改为running，返回任务ID；
   - 若是无记录则创建系统记录，并设置标记True，后续用于系统数据更新节点，提交Celery异步任务（agent节点流程），返回任务ID；

agent节点流程（若是整个流程报错抛异常，则更新任务失败原因和时间）

1. 参数校验（language是否为ZN和 EN之一）和任务状态更新 running；
2. 文件下载节点，基于参数bucket名称和paper_id下载文件到本地 data/temp下，需检验路径是否存在；
3. 接口调用节点，调用paper2slides_server中的/api/chat，返回文件夹路径；
4. 文件上传节点，将文件上传至Minio，基于环境变量和桶数据规则上传指定路径，poster上传图片，slides图片和pdf文件都要上传；
5. 用户数据更新节点，获取文件和图片的Minio地址（不要host，只要桶及后面的资源路径），更新user_paper_agent_result中的 paper_id, source, agent_type 的记录为running的任务（如果标记为True，则更新所有，反之根据任务id更新单个任务），更新file_path和images（images只有slides才有），状态，时间等；
6.  系统数据更新节点，根据标记来决定是否执行此节点，根据paper_id, source, agent_type 更新 system_paper_agent_result 中的任务file_path；



### 2、任务删除接口

**接口路径**: `DELETE /namespace/{namespace}/tasks/{task_id}/delete`

**功能描述**: 删除任务，运行中任务停止执行

**请求参数**: 

- `task_id`: 任务ID（路径参数）

**响应结果**:

```json
{
  "code": 200,
  "message": "任务删除成功"
}
```

**业务逻辑**:

1. 根据task_id查询任务；
2. 如任务状态为"运行中(10)"，调用Celery revoke停止任务；
3. 删除用户数据库任务记录；
4. 不影响系统论文的默认结果（system_paper_agent_result表）；



### 3、任务详情接口

**接口路径**: `GET /namespace/{namespace}/tasks/{task_id}/detail`

**功能描述**: 查询任务详情，Poster和Slides返回结果不一样,主要区别在于slides多了图片数组；

**请求参数**:

- `task_id`: 任务ID（路径参数）

**响应结果（Poster类型）**:

```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "task_id": "任务ID",
    "title": "全景信息图",
    "agent_type": "poster",
    "status": "success", 
    "error_reason": "失败原因",
    "file_path": "结果文件下载地址",
    "image_urls": [],
    "start_time": "开始时间",
    "end_time": "结束时间",
    "created_time": "创建时间",
    "paper_id": "论文ID",
    "source": "论文数据源"
  }
}
```

**响应结果（Slides类型）**:

```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "task_id": "任务ID",
    "title": "演示文稿",
    "agent_type": "slides",
    "status": "success",
    "error_reason": "失败原因",
    "file_path": "pdf文件下载地址",
    "image_urls": [ 
      "image_1.png",
      "image_2.png"
    ],
    "start_time": "开始时间",
    "end_time": "结束时间",
    "created_time": "创建时间",
    "paper_id": "论文ID",
    "source": "论文数据源"
  }
}
```

**业务逻辑**:

1. 根据task_id查询任务；
2. 将查询的任务数据复制resp；
3. Slides类型需额外返回image_urls数组；



### 4、任务下载接口

**接口路径**: `GET /namespace/{namespace}/tasks/{task_id}/download`

**功能描述**: 获取生成任务的文件下载地址

**请求参数**:

- `task_id`: 任务ID（路径参数）

**响应结果**:

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "file_path": "MinIO文件下载地址",
    "expires_in": 3600  // 链接有效期（秒）
  }
}
```

**业务逻辑**:

1. 根据task_id查询任务；
2. 生成MinIO临时访问链接；
3. 返回下载地址和有效期；



### 5、论文任务分页接口

**接口路径**: `GET /namespace/{namespace}/tasks/page`

**功能描述**: 一个论文有多种类型的任务，根据用户ID和paperID，source分页查询任务；

**请求参数**:

- `user_id`: 用户ID（必填）
- `paper_id`: 论文ID（必填）
- `source`: 论文数据源（必填）
- `page`: 页码（默认1，传0时查询所有数据）
- `page_size`: 每页数量（默认10）

**响应结果**:

```json
{
  "code": 200,
  "message": "查询成功",
  "data": {
    "total": 100,
    "page": 1,
    "page_size": 10,
    "items": [
      {
        "task_id": "任务ID",
        "title": "全景信息图",
        "agent_type": "poster",
        "status": "success",
        "created_time": "创建时间",
        "paper_id": "论文ID",
        "source": "论文数据源"
      }
    ]
  }
}
```

**业务逻辑**:

1. 根据user_id、paper_id、source筛选任务
2. 分页返回任务列表（仅返回标题、类型、时间等基础信息）
3. 按创建时间倒序排列
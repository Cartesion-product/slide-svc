# 项目说明文档

## 1. 项目概述

**项目名称**：演示文稿Agent服务（slide-svc）

**核心功能**：基于学术论文MD文件，生成PPT演示文稿（slides）和全景信息图（poster）。用户通过API提交任务，服务异步处理并返回MinIO存储路径。

**技术栈**：
- Web框架：FastAPI
- 任务队列：Celery + Redis
- 智能体框架：LangGraph
- 数据库：MongoDB
- 对象存储：MinIO

## 2. 项目架构

采用**三层异步架构**：

```
API层（FastAPI）→ 任务队列（Celery + Redis）→ 智能体执行（LangGraph）
                ↓
           数据存储（MongoDB + MinIO）
```

**核心组件**：
- **API层**：提供REST接口，接收任务请求
- **服务层**：任务管理、文件上传下载、队列控制
- **智能体层**：LangGraph工作流，执行生成任务
- **数据层**：MongoDB存储任务记录，MinIO存储文件

**技术选型**：Celery处理异步任务，Redis提供高性能队列，LangGraph管理复杂工作流。

## 3. 目录结构

```
slide-svc/
├── api/                    # API接口层
│   ├── routers/           # 路由定义
│   └── api_server.py      # FastAPI服务器
├── agents/                # LangGraph智能体
│   └── slides_agent.py    # Slides生成智能体
├── services/              # 业务服务层
│   ├── task_service.py    # 任务管理服务
│   ├── minio_service.py   # MinIO文件服务
│   └── paper2slides_service.py # 生成服务
├── repositories/          # 数据仓库层
│   ├── user_paper_repo.py # 用户论文仓库
│   └── system_paper_repo.py # 系统论文仓库
├── models/                # 数据模型
│   └── entities/         # 实体定义
├── celery_app/            # Celery任务配置
│   ├── celery_config.py   # Celery配置
│   └── tasks.py          # 异步任务定义
├── common/                # 公共模块
│   ├── redis_manager.py  # Redis队列管理
│   └── enums.py          # 枚举定义
└── config/                # 配置管理
    └── settings.py       # 配置类
```

## 4. 核心模块

### 4.1 API层
**路由文件**：`api/routers/paper2slides_router.py`

**核心接口**：
- `POST /namespace/{namespace}/tasks/create` - 创建任务
- `DELETE /namespace/{namespace}/tasks/{task_id}/delete` - 删除任务
- `GET /namespace/{namespace}/tasks/{task_id}/detail` - 查询任务详情
- `GET /namespace/{namespace}/tasks/{task_id}/download` - 获取下载链接
- `GET /namespace/{namespace}/tasks/page` - 任务分页列表

**认证**：通过`token_decoder`依赖从JWT token中获取user_id。

### 4.2 服务层

**TaskService**（`services/task_service.py`）
- 任务创建、删除、查询
- 队列容量检查（running上限2，waiting上限5）
- 系统论文默认结果复用逻辑
- 协调Celery任务提交

**MinIOService**（`services/minio_service.py`）
- 文件上传下载
- 路径规则：system论文用`source/paper_id`，user论文用`user_id/paper_id`
- PDF上传根目录，图片上传`images/`子目录

**RedisQueueManager**（`common/redis_manager.py`）
- Redis键：`slide_svc:queue:running`（集合）、`slide_svc:queue:waiting`（列表）
- 原子操作保证并发安全
- 性能提升：从MongoDB的10-100ms优化到<1ms

### 4.3 智能体层

**SlidesAgent**（`agents/slides_agent.py`）

**6节点工作流**（线性流程）：
1. **validate_params** - 参数校验，language为EN时style加"_en"后缀
2. **download_file** - 从MinIO下载MD文件（source_path格式：`bucket_name/object_key`）
3. **call_api** - 调用Paper2SlidesService生成文件
4. **upload_files** - 上传到MinIO
5. **update_user_data** - 更新用户任务，update_system为True时批量更新
6. **update_system_data** - 更新系统论文结果（仅system论文）

### 4.4 任务队列

**Celery配置**（`celery_app/celery_config.py`）
- Broker：Redis（/0）
- Backend：Redis（/1）
- 队列名：slides
- Worker并发：2线程池

**调度机制**：
- 任务完成→decrement_running()→schedule_from_waiting_queue()
- 删除任务→revoke()→decrement_running()→schedule_from_waiting_queue()

**初始化**（`api/api_server.py` startup事件）：
- 重置Redis队列状态
- 从MongoDB同步running和waiting状态

### 4.5 数据层

**实体模型**：
- `UserPaperResult`（`models/entities/user_paper_result.py`）：用户任务结果
- `SystemPaperResult`（`models/entities/system_paper_result.py`）：系统论文默认结果

**仓库模式**：
- `UserPaperRepository`：用户任务CRUD
- `SystemPaperRepository`：系统论文结果CRUD

## 5. 关键业务逻辑

**系统论文vs用户论文**：
- System论文：查询`system_paper_agent_result`表，有默认结果则直接返回，无则创建并生成
- User论文：直接生成

**update_system标记**：
- True：系统首次生成，任务完成后批量更新所有running的同类型任务
- False：用户重新生成，只更新当前任务

**队列控制**：
- running未满（<2）：立即运行
- running已满：进入waiting队列（最多5个）
- waiting已满：返回503繁忙

**默认结果复用**：
- 用户第一次创建同论文同类型任务：使用系统默认结果
- 用户之前创建过：重新生成

## 6. 技术要点

**Redis队列优化**：
- 替代MongoDB查询，性能提升10-100倍
- 原子操作：`scard`、`lpush`、`rpop`等

**LangGraph异步处理**：
- 状态驱动工作流
- 节点间传递state字典
- 支持复杂的业务流程编排

**MinIO路径规则**：
- System论文：`{bucket_name}/{source}/{paper_id}/{filename}`
- User论文：`{bucket_name}/{user_id}/{paper_id}/{filename}`
- 图片：`{bucket_name}/.../images/{filename}`

**source_path参数**：
- 格式：`bucket_name/object_key`（完整路径，包含桶名）
- 用于下载节点解析bucket_name和object_name
- 前端必须提供

## 7. 配置说明

**关键环境变量**（`config/settings.py`）：
- `SLIDES_MAX_RUNNING_TASKS=2` - 最大并行数
- `SLIDES_MAX_WAITING_TASKS=5` - 最大等待数
- `SYSTEM_SLIDES_MINIO_BUCKET=kb-slide-system` - 系统slides桶
- `USER_SLIDES_MINIO_BUCKET=kb-slide-user` - 用户slides桶

**桶名映射**：
```python
('slides', 'system') → kb-slide-system
('slides', 'user') → kb-slide-user
('poster', 'system') → kb-poster-system
('poster', 'user') → kb-poster-user
```

## 8. 数据库设计

**user_paper_agent_result集合**：
- 主键：_id（等于result_id）
- 索引：idx_user_paper（user_id, paper_id, source）
- 索引：idx_created_time（created_time DESC）

**system_paper_agent_result集合**：
- 主键：_id（等于result_id）
- 索引：idx_system_paper（paper_id, source, agent_type）
- 索引：idx_created_time（created_time DESC）

## 9. 部署与运行

**依赖安装**：
```bash
pip install -r requirements.txt
```

**启动服务**：
```bash
python main.py
```

**启动流程**：
1. 加载环境变量（appconfig.json）
2. 启动Celery worker（并发2线程）
3. 初始化MongoDB连接和索引
4. 初始化Redis队列（从MongoDB同步）
5. 启动FastAPI服务器（端口5003）

## 10. 重要注意事项

**Redis队列初始化**：
- 服务启动时必须初始化Redis队列
- 从MongoDB同步running和waiting状态
- 避免队列状态不一致

**source_path格式**：
- 必须包含bucket_name：`kb-paper-parsed/arxiv/123456/123456.md`
- download_file_node会按第一个"/"分割

**上传路径规范**：
- 系统论文：使用source（如"arxiv"）
- 用户论文：使用user_id
- source参数不是source_path，是论文来源标识

**已知问题**：
- Worker重启时等待队列任务不会自动恢复（需重启API服务）
- Redis和MongoDB状态可能不一致（定期检查）

**相关文档**：
- `data/接口设计.md` - API接口详细设计
- `data/演示文稿Agent服务表设计.md` - 数据库表结构
- `data/修改记录/` - 历史修改记录
